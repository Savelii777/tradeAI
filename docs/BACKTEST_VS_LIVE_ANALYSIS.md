# Backtest vs Live Trading Discrepancy Analysis

## –ü—Ä–æ–±–ª–µ–º–∞
–ú–æ–¥–µ–ª—å –Ω–∞ –±—ç–∫—Ç–µ—Å—Ç–µ –¥–∞—ë—Ç ~14 —Å–∏–≥–Ω–∞–ª–æ–≤ –≤ –¥–µ–Ω—å –∏ 70%+ –≤–∏–Ω—Ä–µ–π—Ç, –Ω–æ –Ω–∞ –ª–∞–π–≤–µ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–∏–≥–Ω–∞–ª–æ–≤.

## ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø (–ü–†–ò–ú–ï–ù–ï–ù–´)

### FIX #1: –û—Ç–∫–ª—é—á–µ–Ω–∞ Rolling Normalization –≤ MTFFeatureEngine
**–§–∞–π–ª:** `scripts/train_mtf.py`, —Ñ—É–Ω–∫—Ü–∏—è `generate_m5_signal_features()`

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `normalize=False` –ø—Ä–∏ –≤—ã–∑–æ–≤–µ `generate_all_features()`.

**–ü—Ä–∏—á–∏–Ω–∞:** Rolling z-score –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Å –æ–∫–Ω–æ–º 500 –±–∞—Ä–æ–≤ –¥–∞—ë—Ç —Ä–∞–∑–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
–æ—Ç –¥–ª–∏–Ω—ã –∏—Å—Ç–æ—Ä–∏–∏ –¥–∞–Ω–Ω—ã—Ö. –ù–∞ –±—ç–∫—Ç–µ—Å—Ç–µ 60+ –¥–Ω–µ–π (17,000+ —Å–≤–µ—á–µ–π), –Ω–∞ –ª–∞–π–≤–µ —Ç–æ–ª—å–∫–æ 1000-2000.

```python
# –ë–´–õ–û:
features = self.feature_engine.generate_all_features(df)

# –°–¢–ê–õ–û:
features = self.feature_engine.generate_all_features(df, normalize=False)
```

### FIX #2: –£–≤–µ–ª–∏—á–µ–Ω LOOKBACK –∏ –¥–æ–±–∞–≤–ª–µ–Ω WARMUP_BARS
**–§–∞–π–ª:** `scripts/live_trading_mexc_v8.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- LOOKBACK —É–≤–µ–ª–∏—á–µ–Ω —Å 1000 –¥–æ 2000
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞ WARMUP_BARS = 500
- –ü–µ—Ä–≤—ã–µ 500 –±–∞—Ä–æ–≤ –ø–æ—Å–ª–µ —Ä–∞—Å—á—ë—Ç–∞ —Ñ–∏—á–µ–π –æ—Ç–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è –∫–∞–∫ –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã–µ

**–ü—Ä–∏—á–∏–Ω–∞:** EMA-200 –∏ –¥—Ä—É–≥–∏–µ –¥–ª–∏–Ω–Ω—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Ç—Ä–µ–±—É—é—Ç –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏.
–ü–µ—Ä–≤—ã–µ 200-500 –±–∞—Ä–æ–≤ –∏–º–µ—é—Ç drift –æ—Ç –Ω–∞—á–∞–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π.

```python
# –ù–û–í–´–ô –ö–û–î:
LOOKBACK = 2000  # –£–≤–µ–ª–∏—á–µ–Ω–æ —Å 1000
WARMUP_BARS = 500  # –ù–æ–≤–∞—è –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞

# –í –∫–æ–¥–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏:
df = df.iloc[WARMUP_BARS:]  # –û—Ç–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
```

### FIX #3: –°–æ–∑–¥–∞–Ω –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π —Å–∫—Ä–∏–ø—Ç
**–§–∞–π–ª:** `scripts/diagnose_live_vs_backtest.py`

–°–∫—Ä–∏–ø—Ç –ø–æ–∑–≤–æ–ª—è–µ—Ç:
- –°—Ä–∞–≤–Ω–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è —Ñ–∏—á–µ–π –Ω–∞ –æ–¥–Ω–∏—Ö –∏ —Ç–µ—Ö –∂–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –º–µ—Ç–∫–∞—Ö
- –í—ã—è–≤–∏—Ç—å —Ñ–∏—á–∏ —Å –Ω–∞–∏–±–æ–ª—å—à–∏–º drift
- –°—Ä–∞–≤–Ω–∏—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
```bash
python scripts/diagnose_live_vs_backtest.py --pair BTC_USDT_USDT
python scripts/diagnose_live_vs_backtest.py --all-pairs
```

---

## –ù–∞–π–¥–µ–Ω–Ω—ã–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã (–î–ï–¢–ê–õ–ò)

### üî¥ CRITICAL #1: Rolling Normalization –≤ FeatureEngine

**–ì–¥–µ:** `src/features/feature_engine.py`, —Ñ—É–Ω–∫—Ü–∏—è `normalize_features()`

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –æ–±—É—á–µ–Ω–∏–∏ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `generate_m5_signal_features()` ‚Üí `generate_all_features(df, normalize=True)`, 
–∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏–º–µ–Ω—è–µ—Ç **rolling z-score –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é** —Å –æ–∫–Ω–æ–º 500 –±–∞—Ä–æ–≤:

```python
def normalize_series(series, window=500, method='zscore'):
    rolling_mean = series.rolling(window=window, min_periods=1).mean()
    rolling_std = series.rolling(window=window, min_periods=1).std()
    return (series - rolling_mean) / rolling_std
```

**–ù–∞ –ª–∞–π–≤–µ:** `prepare_features()` –≤—ã–∑—ã–≤–∞–µ—Ç —Ç–æ—Ç –∂–µ `mtf_fe.align_timeframes()`, 
–∫–æ—Ç–æ—Ä—ã–π –≤—ã–∑—ã–≤–∞–µ—Ç `generate_m5_signal_features()` ‚Üí `generate_all_features(df)` —Å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–µ–π.

**–ù–û:** –ù–∞ –±—ç–∫—Ç–µ—Å—Ç–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–¥–µ—Ä–∂–∞—Ç 60+ –¥–Ω–µ–π –∏—Å—Ç–æ—Ä–∏–∏ (17,000+ M5 —Å–≤–µ—á–µ–π), 
–∞ –Ω–∞ –ª–∞–π–≤–µ —Ç–æ–ª—å–∫–æ ~1000 —Å–≤–µ—á–µ–π (LOOKBACK=1000).

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** Rolling z-score —Å window=500 –ø—Ä–∏ 1000 —Å–≤–µ—á–∞—Ö –¥–∞—ë—Ç —Å–æ–≤–µ—Ä—à–µ–Ω–Ω–æ –¥—Ä—É–≥–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è —á–µ–º –ø—Ä–∏ 17,000 —Å–≤–µ—á–∞—Ö.
–ü–µ—Ä–≤—ã–µ 500 —Å–≤–µ—á–µ–π –∏–º–µ—é—Ç min_periods=1, —á—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç —á—Ç–æ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–∞.

**–ü—Ä–∏–º–µ—Ä:**
- Backtest: RSI –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç—Å—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ 500-—Å–≤–µ—á–Ω–æ–≥–æ rolling —Å—Ä–µ–¥–Ω–µ–≥–æ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2.5 –¥–Ω—è
- Live: RSI –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç—Å—è –ø–æ –ø–µ—Ä–≤—ã–º 500 —Å–≤–µ—á–∞–º, –≥–¥–µ rolling mean –µ—â—ë –Ω–µ —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä–æ–≤–∞–ª—Å—è

---

### üî¥ CRITICAL #2: –î–ª–∏–Ω–∞ –¥–∞–Ω–Ω—ã—Ö –∏ EMA-200 warmup

**–ì–¥–µ:** `live_trading_mexc_v8.py`, LOOKBACK=1000 (–±—ã–ª–æ)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–æ–¥–µ–ª—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç EMA-200, –∫–æ—Ç–æ—Ä—ã–π —Ç—Ä–µ–±—É–µ—Ç ~200*5=1000 –±–∞—Ä–æ–≤ –¥–ª—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏.
–ü—Ä–∏ LOOKBACK=1000 –ø–µ—Ä–≤—ã–µ ~200-500 —Å—Ç—Ä–æ–∫ –ø–æ—Å–ª–µ align_timeframes –±—É–¥—É—Ç –∏–º–µ—Ç—å –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è EMA-200.

**–ù–∞ –±—ç–∫—Ç–µ—Å—Ç–µ:** –î–∞–Ω–Ω—ã–µ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å ~60 –¥–Ω–µ–π –Ω–∞–∑–∞–¥, EMA-200 –ø–æ–ª–Ω–æ—Å—Ç—å—é "–ø—Ä–æ–≥—Ä–µ–ª—Å—è" –∫ –º–æ–º–µ–Ω—Ç—É —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö.

**–ù–∞ –ª–∞–π–≤–µ:** –ü–æ—Å–ª–µ warmup (~200 –±–∞—Ä–æ–≤) –æ—Å—Ç–∞—ë—Ç—Å—è —Ç–æ–ª—å–∫–æ ~800 –±–∞—Ä–æ–≤, –∏–∑ –∫–æ—Ç–æ—Ä—ã—Ö:
- –ü–µ—Ä–≤—ã–µ 200-300 –µ—â—ë –∏–º–µ—é—Ç drift –æ—Ç –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è EMA
- –û—Å—Ç–∞—ë—Ç—Å—è ~500-600 "—á–∏—Å—Ç—ã—Ö" –±–∞—Ä–æ–≤

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –§–∏—á–∏ —Ç–∏–ø–∞ `m5_ema_200_dist`, `m5_price_above_ema_200` –∏–º–µ—é—Ç —Å–º–µ—â—ë–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è.

---

## ‚ö†Ô∏è –í–ê–ñ–ù–û: –ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

–ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è `train_mtf.py` (–æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏) **–ù–ï–û–ë–•–û–î–ò–ú–û –ü–ï–†–ï–û–ë–£–ß–ò–¢–¨ –ú–û–î–ï–õ–¨**!

–¢–µ–∫—É—â–∞—è –º–æ–¥–µ–ª—å –±—ã–ª–∞ –æ–±—É—á–µ–Ω–∞ –Ω–∞ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö —Ñ–∏—á–∞—Ö. –ü–æ—Å–ª–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏
—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ñ–∏—á–µ–π –∏–∑–º–µ–Ω—è—Ç—Å—è, –∏ –º–æ–¥–µ–ª—å –±—É–¥–µ—Ç –¥–∞–≤–∞—Ç—å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è.

**–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏—è:**
```bash
python scripts/train_v3_dynamic.py --days 60 --test_days 14
```

---

## –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ —Å–∫—Ä–∏–ø—Ç—ã

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å feature_names.joblib –Ω–∞ cumsum —Ñ–∏—á–∏:
```bash
python -c "
import joblib
features = joblib.load('models/v8_improved/feature_names.joblib')
cumsum_patterns = ['obv', 'cumsum', 'bars_since', 'consecutive', 'swing_high_price', 'swing_low_price']
bad = [f for f in features if any(p in f.lower() for p in cumsum_patterns)]
print(f'Found {len(bad)} cumsum features: {bad}')
"
```

### –°—Ä–∞–≤–Ω–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ñ–∏—á–µ–π:
```bash
python scripts/compare_feature_distributions.py --pair BTC_USDT_USDT --hours 48
```

### –ó–∞–ø—É—Å—Ç–∏—Ç—å preflight check:
```bash
python scripts/preflight_check.py --verbose
```

### –ó–∞–ø—É—Å—Ç–∏—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É backtest vs live:
```bash
python scripts/diagnose_live_vs_backtest.py --pair BTC_USDT_USDT
```

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è - **Rolling Normalization** –∏ **–Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–π warmup**.
–ú–æ–¥–µ–ª—å –æ–±—É—á–µ–Ω–∞ –Ω–∞ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Å –¥–ª–∏–Ω–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–µ–π, –∞ –Ω–∞ –ª–∞–π–≤–µ –≤–∏–¥–∏—Ç 
–¥–∞–Ω–Ω—ã–µ —Å –∫–æ—Ä–æ—Ç–∫–æ–π –∏—Å—Ç–æ—Ä–∏–µ–π –≥–¥–µ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –Ω–µ —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä–æ–≤–∞–ª–∞—Å—å.

**–ü—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è:**
1. ‚úÖ –û—Ç–∫–ª—é—á–µ–Ω–∞ rolling normalization –≤ train_mtf.py
2. ‚úÖ –£–≤–µ–ª–∏—á–µ–Ω LOOKBACK –¥–æ 2000
3. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω warmup skip 500 –±–∞—Ä–æ–≤
4. ‚úÖ –°–æ–∑–¥–∞–Ω –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π —Å–∫—Ä–∏–ø—Ç

**–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:**
1. –ü–µ—Ä–µ–æ–±—É—á–∏—Ç—å –º–æ–¥–µ–ª—å: `python scripts/train_v3_dynamic.py --days 60 --test_days 14`
2. –ó–∞–ø—É—Å—Ç–∏—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É: `python scripts/diagnose_live_vs_backtest.py --all-pairs`
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å preflight: `python scripts/preflight_check.py --verbose`
